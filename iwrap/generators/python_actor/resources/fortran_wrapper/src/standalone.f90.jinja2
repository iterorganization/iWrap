program standalone

{% if code_description.language_specific.mpi %}
    use mpi
{% endif %}
    use iwrap_defs
    use iwrap_tools
    use wrapper

    implicit none

    !---------------------------------------------------------
    integer, parameter :: IDS_ARGS_NO = {{code_description.arguments | length}}
    type(ids_description_t), dimension(IDS_ARGS_NO) :: db_entry_desc_array
    integer :: status

    !----  Status info  ----
    type(status_t) :: status_info

    !----  Code parameters  ----
    character(len=:), allocatable :: xml_string
{% if code_description.code_parameters.parameters and code_description.code_parameters.schema %}
    character(len=*), parameter :: XSD_FILE = "../input/{{code_description.code_parameters.schema.split('/')[-1]}}"
    character(len=:), allocatable :: xsd_string
    type(code_parameters_t) :: code_params
{% endif %}

{% if code_description.language_specific.mpi %}
    !----  MPI  ----
    logical :: was_mpi_finalized
    integer :: process_rank
    call MPI_Init(status)
    call MPI_COMM_RANK(MPI_COMM_WORLD, process_rank, status)
{% endif %}

   !-----------Reading input ---------------------
    status = read_input(db_entry_desc_array, xml_string)
    if (status /= 0) STOP -1

{% if code_description.code_parameters.parameters and code_description.code_parameters.schema %}
    ! Read code parameters to structure
    xsd_string = read_codeparams_schema(XSD_FILE)

    code_params%params = convert2Cptr(xml_string)
    code_params%params_size = LEN(xml_string)

    code_params%schema = convert2Cptr(xsd_string)
    code_params%schema_size = LEN(xsd_string)

{% endif %}


     {% if code_description.subroutines.init %}
    ! - - - - - - - - - - - - - - - - - -INIT SBRT CALL - - - - - - - - - - - - - - - - - - - - - - - - - -
    call init_{{actor_settings.actor_name}}_wrapper(&
        {% if code_description.code_parameters.parameters and code_description.code_parameters.schema %}
                code_params,  &
        {% endif %}
                status_info)
    {% endif %}




    !-----------Open DB entries---------------------
    call open_db_entries(db_entry_desc_array)

    !!!!!!!!! Fortran wrapper !!!!!!!!!!!!!!!
    call {{actor_settings.actor_name}}_wrapper(&
{% for argument in code_description.arguments %}
                db_entry_desc_array({{loop.index}}),  &
{% endfor %}
{% if code_description.code_parameters.parameters and code_description.code_parameters.schema %}
                code_params,  &
{% endif %}
                status_info)
  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

{% if code_description.language_specific.mpi %}
    if (process_rank == 0) then
       ! --- called only for RANK 0 process
{% endif %}

    !-----------Check status info ---------------------
    call handle_status_info(status_info, "{{actor_settings.actor_name}}")

    !-----------Writing output data to file ---------------------
    call write_output(status_info)

{% if code_description.language_specific.mpi %}
    endif ! --- The end of section called only for RANK 0 process
{% endif %}
    !-----------Close DB entries---------------------
    call close_db_entries(db_entry_desc_array)


     {% if code_description.subroutines.finish %}
    ! - - - - - - - - - - - - - - - - - -FINISH SBRT CALL - - - - - - - - - - - - - - - - - - - - - - - - - -
    call finish_{{actor_settings.actor_name}}_wrapper(status_info)
    {% endif %}

{% if code_description.language_specific.mpi %}
    !----  MPI Finalization ----
    call MPI_finalized(was_mpi_finalized, status)
    if (.not. was_mpi_finalized)   call MPI_Finalize(status)
{% endif %}

end program
